<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovimentaIF - Gerenciar Treinos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-ieo5gL4x1I85z6Nn4Qp7E7gYQx3T8n5b9G5p5M5r8b5+Wj1fFvYV5j5N8W5t4/eG5p5M5p4p5t5a5F5+w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bs-slate-50: #f8fafc;
            --bs-slate-100: #f1f5f9;
            --bs-slate-200: #e2e8f0;
            --bs-slate-300: #cbd5e1;
            --bs-slate-600: #475569;
            --bs-slate-700: #334155;
            --bs-slate-800: #1e293b;
            --bs-emerald-50: #e6f9f3;
            --bs-emerald-100: #d1fae5;
            --bs-emerald-600: #059669;
            --bs-red-500: #ef4444;
            --bs-blue-500: #3b82f6;
        }

        body {
            background-color: var(--bs-slate-50);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        .bg-custom-slate-100 {
            background-color: var(--bs-slate-100);
        }

        .text-custom-slate-600 {
            color: var(--bs-slate-600);
        }

        .text-custom-slate-700 {
            color: var(--bs-slate-700);
        }

        .text-custom-slate-800 {
            color: var(--bs-slate-800);
        }

        .bg-custom-white {
            background-color: white;
        }

        .bg-custom-emerald-50 {
            background-color: var(--bs-emerald-50);
        }

        .text-custom-emerald-600 {
            color: var(--bs-emerald-600);
        }

        .nav-link.active {
            background-color: var(--bs-emerald-50) !important;
            color: var(--bs-slate-700) !important;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="d-flex h-100 bg-custom-slate-100">
        <!-- Sidebar -->
        <aside class="col-md-2 bg-custom-white shadow-lg d-flex flex-column flex-shrink-0">
            <div class="p-4 border-bottom">
                <h1 class="h4 fw-bold text-custom-slate-800">MovimentaIF</h1>
            </div>
            <nav class="nav nav-pills flex-column p-3">
                <a href="dashboard.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-house me-2"></i> Início
                </a>
                <a href="users.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-users me-2"></i> Alunos
                </a>
                <a href="workouts.html" class="nav-link active rounded-pill mt-2">
                    <i class="fa-solid fa-dumbbell me-2"></i> Treinos
                </a>
                <a href="agenda.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-calendar-alt me-2"></i> Agenda
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="col-md-10 d-flex flex-column overflow-hidden">
            <!-- Header -->
            <header class="bg-custom-white shadow-sm p-4 d-flex justify-content-between align-items-center">
                <h2 class="h5 fw-bold text-custom-slate-700">Gerenciar Treinos</h2>
                <div class="d-flex align-items-center">
                    <span id="user-email" class="text-custom-slate-600 me-3"></span>
                    <button id="logout-btn" class="btn btn-danger btn-sm rounded-pill">Sair</button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-grow-1 overflow-auto bg-custom-slate-100 p-4">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <input type="text" id="search-input" class="form-control rounded-pill"
                            placeholder="Buscar treino..." style="max-width: 300px;">
                        <button class="btn btn-success rounded-pill fw-bold" data-bs-toggle="modal"
                            data-bs-target="#addEditWorkoutModal">
                            <i class="fa-solid fa-plus me-2"></i> Adicionar Treino
                        </button>
                    </div>

                    <div id="workouts-list" class="list-group">
                        <div class="d-flex justify-content-center p-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Workout Modal -->
    <div class="modal fade" id="addEditWorkoutModal" tabindex="-1" aria-labelledby="addEditWorkoutModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEditWorkoutModalLabel">Adicionar Novo Treino</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="workoutForm">
                        <input type="hidden" id="workoutId">
                        <div class="mb-3">
                            <label for="workoutName" class="form-label">Título</label>
                            <input type="text" class="form-control" id="workoutName" required>
                        </div>
                        <div class="mb-3">
                            <label for="workoutDescription" class="form-label">Texto Descritivo</label>
                            <textarea class="form-control" id="workoutDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="workoutVideoLink" class="form-label">Link do Vídeo</label>
                            <input type="url" class="form-control" id="workoutVideoLink">
                        </div>
                        <button type="submit" class="btn btn-success w-100 fw-bold rounded-pill">Salvar Treino</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnET6gJ175qHFbHcKm40tynj7s9x4sXqU",
            authDomain: "movimentaif.firebaseapp.com",
            databaseURL: "https://movimentaif-default-rtdb.firebaseio.com",
            projectId: "movimentaif",
            storageBucket: "movimentaif.firebasestorage.app",
            messagingSenderId: "705983497984",
            appId: "1:705983497984:web:f16672db437ce21aa2d5e5",
            measurementId: "G-5K2CYJ742W"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const workoutsList = document.getElementById('workouts-list');
        const workoutForm = document.getElementById('workoutForm');
        const addEditWorkoutModal = new bootstrap.Modal(document.getElementById('addEditWorkoutModal'));
        const modalTitle = document.getElementById('addEditWorkoutModalLabel');

        const API_BASE_URL = 'http://localhost:8080/api/workouts';

        async function getAuthTokenAndFetch(url, options = {}) {
            const user = auth.currentUser;
            if (!user) {
                console.error("No authenticated user to get token for.");
                window.location.replace('index.html');
                return Promise.reject(new Error("No user authenticated."));
            }
            const token = await user.getIdToken();
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            return fetch(url, { ...options, headers });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                fetchWorkouts();
            } else {
                window.location.replace('index.html');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.replace('index.html');
            });
        });

        async function fetchWorkouts() {
            workoutsList.innerHTML = `
                <div class="d-flex justify-content-center p-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            try {
                const response = await getAuthTokenAndFetch(API_BASE_URL);
                if (!response.ok) {
                    throw new Error('Erro ao buscar treinos.');
                }
                const workouts = await response.json();
                renderWorkouts(workouts);
            } catch (error) {
                workoutsList.innerHTML = `<div class="alert alert-danger text-center mt-4" role="alert">Erro ao carregar treinos: ${error.message}</div>`;
            }
        }

        function renderWorkouts(workouts) {
            workoutsList.innerHTML = '';
            if (workouts.length === 0) {
                workoutsList.innerHTML = `<div class="alert alert-info text-center mt-4" role="alert">Nenhum treino cadastrado.</div>`;
                return;
            }
            workouts.forEach(workout => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center my-2 rounded-3 shadow-sm';
                workoutCard.innerHTML = `
                    <div class="d-flex flex-column">
                        <h6 class="mb-1 fw-bold">${workout.workoutName}</h6>
                        <small class="text-muted text-truncate" style="max-width: 400px;">${workout.workoutDescription}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="workout-details.html?id=${workout.workoutId}" class="btn btn-outline-primary btn-sm rounded-pill"><i class="fa-solid fa-info-circle me-1"></i> Detalhes</a>
                        <button class="btn btn-outline-warning btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#addEditWorkoutModal" data-id="${workout.workoutId}"><i class="fa-solid fa-edit me-1"></i> Editar</button>
                        <button class="btn btn-outline-danger btn-sm rounded-pill" data-id="${workout.workoutId}"><i class="fa-solid fa-trash-alt me-1"></i> Excluir</button>
                    </div>
                `;
                workoutsList.appendChild(workoutCard);
            });
        }

        workoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workoutId = document.getElementById('workoutId').value;
            const workoutName = document.getElementById('workoutName').value;
            const workoutDescription = document.getElementById('workoutDescription').value;
            const workoutVideoLink = document.getElementById('workoutVideoLink').value;

            const workoutData = { workoutName, workoutDescription, workoutVideoLink };

            try {
                const url = workoutId ? `${API_BASE_URL}/${workoutId}` : API_BASE_URL;
                const method = workoutId ? 'PUT' : 'POST';

                const response = await getAuthTokenAndFetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workoutData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erro ao salvar o treino.');
                }

                await fetchWorkouts();
                addEditWorkoutModal.hide();

            } catch (error) {
                alert(`Erro: ${error.message}`);
            }
        });

        workoutsList.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (e.target.classList.contains('btn-outline-danger')) {
                if (confirm('Tem certeza que deseja excluir este treino?')) {
                    try {
                        const response = await getAuthTokenAndFetch(`${API_BASE_URL}/${id}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || 'Erro ao excluir o treino.');
                        }
                        await fetchWorkouts();
                    } catch (error) {
                        alert(`Erro: ${error.message}`);
                    }
                }
            } else if (e.target.classList.contains('btn-outline-warning')) {
                const response = await getAuthTokenAndFetch(`${API_BASE_URL}/${id}`);
                const workout = await response.json();
                document.getElementById('workoutId').value = workout.workoutId;
                document.getElementById('workoutName').value = workout.workoutName;
                document.getElementById('workoutDescription').value = workout.workoutDescription;
                document.getElementById('workoutVideoLink').value = workout.workoutVideoLink;
                modalTitle.textContent = 'Editar Treino';
            }
        });

        document.getElementById('addEditWorkoutModal').addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button ? button.getAttribute('data-id') : null;
            if (!id) {
                modalTitle.textContent = 'Adicionar Novo Treino';
                document.getElementById('workoutForm').reset();
                document.getElementById('workoutId').value = '';
            }
        });
    </script>
</body>

</html>