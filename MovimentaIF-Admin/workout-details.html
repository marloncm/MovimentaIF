<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovimentaIF - Detalhes do Treino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-ieo5gL4x1I85z6Nn4Qp7E7gYQx3T8n5b9G5p5M5r8b5+Wj1fFvYV5j5N8W5t4/eG5p5M5p4p5t5a5F5+w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bs-slate-50: #f8fafc;
            --bs-slate-100: #f1f5f9;
            --bs-slate-200: #e2e8f0;
            --bs-slate-300: #cbd5e1;
            --bs-slate-600: #475569;
            --bs-slate-700: #334155;
            --bs-slate-800: #1e293b;
            --bs-emerald-50: #e6f9f3;
            --bs-emerald-100: #d1fae5;
            --bs-emerald-600: #059669;
            --bs-red-500: #ef4444;
            --bs-blue-500: #3b82f6;
        }

        body {
            background-color: var(--bs-slate-50);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        .bg-custom-slate-100 {
            background-color: var(--bs-slate-100);
        }

        .text-custom-slate-600 {
            color: var(--bs-slate-600);
        }

        .text-custom-slate-700 {
            color: var(--bs-slate-700);
        }

        .text-custom-slate-800 {
            color: var(--bs-slate-800);
        }

        .bg-custom-white {
            background-color: white;
        }

        .bg-custom-emerald-50 {
            background-color: var(--bs-emerald-50);
        }

        .text-custom-emerald-600 {
            color: var(--bs-emerald-600);
        }

        .nav-link.active {
            background-color: var(--bs-emerald-50) !important;
            color: var(--bs-slate-700) !important;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="d-flex h-100 bg-custom-slate-100">
        <!-- Sidebar -->
        <aside class="col-md-2 bg-custom-white shadow-lg d-flex flex-column flex-shrink-0">
            <div class="p-4 border-bottom">
                <h1 class="h4 fw-bold text-custom-slate-800">MovimentaIF</h1>
            </div>
            <nav class="nav nav-pills flex-column p-3">
                <a href="dashboard.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-house me-2"></i> Início
                </a>
                <a href="users.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-users me-2"></i> Alunos
                </a>
                <a href="workouts.html" class="nav-link active rounded-pill mt-2">
                    <i class="fa-solid fa-dumbbell me-2"></i> Treinos
                </a>
                <a href="agenda.html" class="nav-link text-custom-slate-600 rounded-pill mt-2">
                    <i class="fa-solid fa-calendar-alt me-2"></i> Agenda
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="col-md-10 d-flex flex-column overflow-hidden">
            <!-- Header -->
            <header class="bg-custom-white shadow-sm p-4 d-flex justify-content-between align-items-center">
                <h2 class="h5 fw-bold text-custom-slate-700">Detalhes do Treino</h2>
                <div class="d-flex align-items-center">
                    <span id="user-email" class="text-custom-slate-600 me-3"></span>
                    <button id="logout-btn" class="btn btn-danger btn-sm rounded-pill">Sair</button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-grow-1 overflow-auto bg-custom-slate-100 p-4 d-flex justify-content-center">
                <div class="container-fluid" style="max-width: 900px;">
                    <button id="back-btn" class="btn btn-secondary btn-sm mb-3 rounded-pill"><i
                            class="fa-solid fa-arrow-left me-1"></i> Voltar</button>

                    <div id="workout-content" class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnET6gJ175qHFbHcKm40tynj7s9x4sXqU",
            authDomain: "movimentaif.firebaseapp.com",
            databaseURL: "https://movimentaif-default-rtdb.firebaseio.com",
            projectId: "movimentaif",
            storageBucket: "movimentaif.firebasestorage.app",
            messagingSenderId: "705983497984",
            appId: "1:705983497984:web:f16672db437ce21aa2d5e5",
            measurementId: "G-5K2CYJ742W"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const workoutContent = document.getElementById('workout-content');
        const API_BASE_URL = 'http://localhost:8080/api/workouts';

        async function getAuthTokenAndFetch(url, options = {}) {
            const user = auth.currentUser;
            if (!user) {
                console.error("No authenticated user to get token for.");
                window.location.replace('index.html');
                return Promise.reject(new Error("No user authenticated."));
            }
            const token = await user.getIdToken();
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            return fetch(url, { ...options, headers });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                const urlParams = new URLSearchParams(window.location.search);
                const workoutId = urlParams.get('id');
                if (workoutId) {
                    fetchWorkoutDetails(workoutId);
                } else {
                    workoutContent.innerHTML = `<div class="alert alert-warning">Treino não encontrado.</div>`;
                }
            } else {
                window.location.replace('index.html');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.replace('index.html');
            });
        });

        document.getElementById('back-btn').addEventListener('click', () => {
            window.location.href = 'workouts.html';
        });

        async function fetchWorkoutDetails(id) {
            try {
                const response = await getAuthTokenAndFetch(`${API_BASE_URL}/${id}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erro ao buscar detalhes do treino.');
                }
                const workout = await response.json();
                renderWorkoutDetails(workout);
            } catch (error) {
                workoutContent.innerHTML = `<div class="alert alert-danger text-center mt-4" role="alert">Erro ao carregar os detalhes do treino: ${error.message}</div>`;
            }
        }

        function getYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function renderWorkoutDetails(workout) {
            const videoId = getYouTubeVideoId(workout.workoutVideoLink);
            const videoEmbed = videoId ? `
                <div class="ratio ratio-16x9 rounded-3 shadow mb-4">
                    <iframe src="https://www.youtube.com/embed/${videoId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            ` : `<div class="alert alert-warning text-center">Este treino não possui um link de vídeo válido.</div>`;

            workoutContent.innerHTML = `
                <div class="card shadow-sm p-4 mb-4">
                    <h3 class="card-title fw-bold text-custom-slate-800">${workout.workoutName}</h3>
                    <p class="card-text text-muted">${workout.workoutDescription}</p>
                </div>
                ${videoEmbed}
            `;
        }
    </script>
</body>

</html>